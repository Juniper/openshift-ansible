---
- name: Run contrail-status command to get status of contrail services.
  command: /usr/bin/contrail-status
  register: contrail_status_output
  delegate_to: "{{ delegate_host }}"
  when: delegate_host is defined

- set_fact:
    schema_valid: true

- name: If Schema Transformer is not in active or backup state, mark it as being in invalid state.
  set_fact:
    schema_valid: false
  when:
    - '"schema: active" not in contrail_status_output.stdout'
    - '"schema: backup" not in contrail_status_output.stdout'

- when:
    - not schema_valid
    - delegate_host is defined
    
    # Schema Transformer is invalid.
    # We will attempt to resuscitate it by restarting its container.

  block:
    - name: Get docker container details of Schema Transformer
      command: docker ps --filter "name=schema" -q
      register: schema_docker_output
      ignore_errors: yes
      delegate_to: "{{ delegate_host }}"

    - name: Restart Schema Transformer container "{{ schema_docker_output.stdout }}"
      command: docker restart "{{ schema_docker_output.stdout }}"
      when: schema_docker_output.stdout != ""
      ignore_errors: yes
      delegate_to: "{{ delegate_host }}"

    - name: Wait for Schema Transformer to restart.
      wait_for: timeout=10
      when: schema_docker_output.stdout != ""
      delegate_to: "{{ delegate_host }}"
